<!-- templates/index.html -->

<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ã²ãè‚‰AIğŸ¥©</title>
    <!-- Font Awesomeã®å°å…¥ -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      integrity="sha512-pGjgLlE+YrFQ0TW0wD7k/yXic6KKx9vj9JYvAHRpDmuv4I3+7+/KzZ+ew3A0+PXmmIdbBwFv20UjKxZPnJY0PA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <style>
      body {
        font-family: "Arial Black", Gadget, sans-serif;
        background-color: #fff8f0; /* ã‚¯ãƒªãƒ¼ãƒ è‰² */
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 50px;
        max-width: 1000px;
        margin: auto;
      }

      h1 {
        color: #8b0000; /* ãƒ€ãƒ¼ã‚¯ãƒ¬ãƒƒãƒ‰ */
        text-align: center;
        font-size: 36px;
        margin-bottom: 10px;
      }

      h2 {
        color: #a52a2a; /* ãƒ–ãƒ©ã‚¦ãƒ³ */
        margin-top: 30px;
        border-bottom: 2px solid #a52a2a;
        padding-bottom: 10px;
        width: 100%;
        text-align: center;
      }

      p {
        color: #555;
        line-height: 1.6;
        text-align: center;
        max-width: 800px;
      }

      .nav {
        text-align: center;
        margin-bottom: 30px;
        background-color: #8b0000; /* ãƒ€ãƒ¼ã‚¯ãƒ¬ãƒƒãƒ‰ */
        padding: 15px 0;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        width: 100%;
      }

      .nav a {
        margin: 0 20px;
        text-decoration: none;
        color: #ffebcd; /* ãƒ–ãƒ©ã‚¦ãƒ³ç³»ã®æ˜ã‚‹ã„è‰² */
        font-weight: bold;
        font-family: "Arial Black", Gadget, sans-serif; /* åŠ›å¼·ã„ãƒ•ã‚©ãƒ³ãƒˆ */
        font-size: 18px;
        position: relative;
        transition: color 0.3s, transform 0.3s;
      }

      .nav a i {
        margin-right: 8px;
      }

      .nav a:hover {
        color: #ffd700; /* ã‚´ãƒ¼ãƒ«ãƒ‰ */
        transform: scale(1.1);
      }

      .nav a.active {
        color: #ffd700;
        border-bottom: 2px solid #ffd700;
      }

      @media (max-width: 600px) {
        .nav a {
          margin: 0 10px;
          font-size: 16px;
        }

        body {
          padding: 20px;
        }

        h1 {
          font-size: 28px;
        }

        h2 {
          font-size: 24px;
        }

        .upload-form label.fileinput,
        .upload-form button {
          font-size: 16px;
          padding: 10px 20px;
        }

        .progress-bar-fill {
          height: 15px;
        }
      }

      .upload-form {
        background: #fff;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 600px;
        margin-top: 20px;
        text-align: center;
      }

      /* ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒœã‚¿ãƒ³ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º */
      .upload-form input[type="file"] {
        display: none;
      }

      .upload-form label.fileinput {
        display: inline-block;
        padding: 12px 30px;
        background-color: #a52a2a; /* ãƒ–ãƒ©ã‚¦ãƒ³ */
        color: #fff8f0; /* ã‚¯ãƒªãƒ¼ãƒ è‰² */
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s, transform 0.3s;
        font-size: 18px;
        font-weight: bold;
        font-family: "Arial Black", Gadget, sans-serif;
      }

      .upload-form label.fileinput:hover {
        background-color: #8b0000; /* ãƒ€ãƒ¼ã‚¯ãƒ¬ãƒƒãƒ‰ */
        transform: scale(1.05);
      }

      .upload-form button {
        width: 100%;
        padding: 15px;
        background-color: #a52a2a; /* ãƒ–ãƒ©ã‚¦ãƒ³ */
        border: none;
        color: #fff8f0; /* ã‚¯ãƒªãƒ¼ãƒ è‰² */
        font-size: 18px;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s, transform 0.3s;
        margin-top: 20px;
        font-family: "Arial Black", Gadget, sans-serif;
      }

      .upload-form button:hover {
        background-color: #8b0000; /* ãƒ€ãƒ¼ã‚¯ãƒ¬ãƒƒãƒ‰ */
        transform: scale(1.05);
      }

      .message {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
        display: none;
        width: 100%;
        max-width: 600px;
        text-align: center;
        font-size: 16px;
      }

      .message.success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .message.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .preview {
        margin-top: 20px;
        display: none;
        width: 100%;
        max-width: 600px;
        text-align: center;
      }

      .preview h3 {
        color: #a52a2a; /* ãƒ–ãƒ©ã‚¦ãƒ³ */
        margin-bottom: 15px;
      }

      .preview img {
        max-width: 100%;
        border-radius: 5px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      }

      .results {
        margin-top: 20px;
        background: #fff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 600px;
        display: none;
      }

      .results h3 {
        margin-bottom: 15px;
        color: #333;
        text-align: center;
      }

      .results ul {
        list-style-type: none;
        padding: 0;
      }

      .results li {
        padding: 10px 0;
        border-bottom: 1px solid #ddd;
        display: flex;
        justify-content: space-between;
        font-size: 18px;
      }

      .results li:last-child {
        border-bottom: none;
      }

      .progress-bar {
        width: 100%;
        background-color: #ddd;
        border-radius: 5px;
        overflow: hidden;
        margin-top: 20px;
      }

      .progress-bar-fill {
        height: 20px;
        background-color: #a52a2a; /* ãƒ–ãƒ©ã‚¦ãƒ³ */
        width: 0%;
        transition: width 0.5s;
      }

      footer {
        text-align: center;
        margin-top: 50px;
        color: #777;
        font-size: 16px;
      }

      button:disabled {
        background-color: #ddd; /* ç°è‰² */
        color: #999; /* ç„¡åŠ¹ã£ã½ã„æ–‡å­—è‰² */
        cursor: not-allowed; /* ç„¡åŠ¹çŠ¶æ…‹ã®ã‚«ãƒ¼ã‚½ãƒ« */
        transform: none; /* ãƒ›ãƒãƒ¼æ™‚ã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’ç„¡åŠ¹åŒ– */
        box-shadow: none; /* å½±ã‚‚ãªãã™ */
      }
    </style>
  </head>
  <body>
    <div class="nav">
      <a href="/" class="active"><i class="fas fa-home"></i>ãƒ›ãƒ¼ãƒ </a>
      <a href="/about"><i class="fas fa-info-circle"></i>å®Ÿé¨“çµæœ</a>
    </div>

    <h1>ã²ãè‚‰AIğŸ¥©</h1>
    <p>AIã¯ã˜ã‚ã¾ã—ãŸ</p>
    <p>ä»Šæ™©ã®ãŠã‹ãšã¯ãƒãƒ³ãƒãƒ¼ã‚°ã€ã§ã‚‚ã¡ã‚‡ã£ã¨å¾…ã£ã¦ã©ã‚ŒãŒè±šã®ã²ãè‚‰ã‹ã—ã‚‰ï¼Ÿ</p>
    <p>
      ãã‚“ãªã¨ãã‚ã‚Šã¾ã™ã‚ˆã­ã€‚ãã‚“ãªã‚ãªãŸã«ã“ã‚Œ<strong>ã€Œã²ãè‚‰AIã€</strong>ã“ã‚Œã•ãˆã‚ã‚Œã°ã‚‚ã†å®‰å¿ƒã€‚ã‚ã®é›£ã—ã„ã²ãè‚‰é¸ã³ã¨ã¯ä»Šæ—¥ã§ãŠã•ã‚‰ã°ã€‚ä»Šã‚ˆã‚Šè±Šã‹ãªäººç”Ÿã‚’é€ã‚ŠãŸã„ã€‚ãã‚“ãªã‚ãªãŸã«ãŠã™ã™ã‚ã€‚ã•ã‚ç´ æ•µãªã²ãè‚‰ãƒ©ã‚¤ãƒ•ã‚’ã€‚
    </p>
    <p>ä»Šã™ããŠè©¦ã—ã‚’</p>

    <div class="upload-form">
      <form id="predictForm">
        <label class="fileinput" for="imageInput"><i class="fas fa-upload"></i> ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</label>
        <input type="file" id="imageInput" accept="image/*" required />
        <button type="submit" id="submitButton" disabled>åˆ†æã‚¹ã‚¿ãƒ¼ãƒˆ</button>
      </form>
    </div>

    <div class="message" id="messageBox"></div>

    <div class="preview" id="previewBox">
      <h3>é€ä¿¡ã—ãŸç”»åƒ</h3>
      <img id="uploadedImage" src="#" alt="Uploaded Image" />
    </div>

    <div class="results" id="resultsBox">
      <h3>äºˆæ¸¬çµæœ:</h3>
      <ul id="resultsList">
        <!-- äºˆæ¸¬çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
      </ul>
    </div>

    <div class="progress-bar" id="progressBar" style="display: none;">
      <div class="progress-bar-fill" id="progressFill"></div>
    </div>

    <footer>
      <p>&copy; 2025 T.Y T.Y T.Y M.R Y.R satokenai.com</p>
    </footer>

    <script>
      // ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã®æ¤œå‡º
      function isMobileDevice() {
        return /Mobi|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      }

      document.getElementById("imageInput").addEventListener("change", function () {
        const fileInput = document.getElementById("imageInput");
        const submitButton = document.getElementById("submitButton");

        // ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã«ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
        if (fileInput.files.length > 0) {
          submitButton.disabled = false;
        } else {
          submitButton.disabled = true;
        }
      });

      document.getElementById("predictForm").addEventListener("submit", async function (event) {
        event.preventDefault();

        const imageInput = document.getElementById("imageInput");
        const file = imageInput.files[0];

        if (!file) {
          showMessage("ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚", "error");
          return;
        }

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
        displayImage(URL.createObjectURL(file));

        try {
          showMessage("äºˆæ¸¬ä¸­...", "success");
          showProgress();

          // ãƒ‡ãƒã‚¤ã‚¹ã®åˆ¤å®š
          const isMobile = isMobileDevice();

          // åœ§ç¸®è¨­å®šã®èª¿æ•´
          let quality = 0.8;
          let maxWidth = 1024; // ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—å‘ã‘ã®æœ€å¤§å¹…

          if (isMobile) {
            quality = 0.6; // ã‚¹ãƒãƒ›å‘ã‘ã®å“è³ª
            maxWidth = 800; // ã‚¹ãƒãƒ›å‘ã‘ã®æœ€å¤§å¹…
          }

          // ç”»åƒã‚’å¤‰æ›
          const convertedFile = await convertImage(file, quality, maxWidth); // JPEGã«å¤‰æ›ã€å“è³ªèª¿æ•´

          // å¤‰æ›å¾Œã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆã‚¹ãƒãƒ›ã®å ´åˆã¯1MBä»¥ä¸‹ï¼‰
          if (isMobile && convertedFile.size > 1 * 1024 * 1024) {
            hideProgress();
            showMessage(`å¤‰æ›å¾Œã®ç”»åƒã‚µã‚¤ã‚ºãŒ1MBã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚`, "error");
            return;
          }

          const formData = new FormData();
          formData.append("file", convertedFile, "converted.jpg"); // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æŒ‡å®š

          const response = await fetch("/predict", {
            method: "POST",
            body: formData,
          });

          hideProgress();

          if (response.ok) {
            const result = await response.json();
            showMessage("äºˆæ¸¬ãŒå®Œäº†ã—ã¾ã—ãŸï¼", "success");
            displayResults(result);
          } else {
            const errorText = await response.text();
            showMessage(`ã‚¨ãƒ©ãƒ¼: ${errorText}`, "error");
            console.error("Error response:", errorText);
          }
        } catch (error) {
          hideProgress();
          showMessage("ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", "error");
          console.error("Error:", error);
        }
      });

      function showMessage(message, type) {
        const messageBox = document.getElementById("messageBox");
        messageBox.textContent = message;
        messageBox.className = `message ${type}`;
        messageBox.style.display = "block";

        // ä¸€å®šæ™‚é–“å¾Œã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤ºã«ã™ã‚‹
        setTimeout(() => {
          messageBox.style.display = "none";
        }, 5000);
      }

      function displayImage(url) {
        const previewBox = document.getElementById("previewBox");
        const uploadedImage = document.getElementById("uploadedImage");
        uploadedImage.src = url;
        previewBox.style.display = "block";
      }

      function displayResults(results) {
        const resultsBox = document.getElementById("resultsBox");
        const resultsList = document.getElementById("resultsList");
        resultsList.innerHTML = "";

        // çµæœã‚’ä¿¡é ¼åº¦ã®é«˜ã„é †ã«ã‚½ãƒ¼ãƒˆ
        const sortedResults = Object.entries(results).sort((a, b) => b[1] - a[1]);

        sortedResults.forEach(([className, probability]) => {
          const listItem = document.createElement("li");
          const icon = className === "pork" ? "ğŸ·" : className === "beef" ? "ğŸ®" : "ğŸ”";
          listItem.innerHTML = `<span>${icon}</span><span><strong>${(probability * 100).toFixed(2)}%</strong></span>`;
          resultsList.appendChild(listItem);
        });
        resultsBox.style.display = "block";
      }

      // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®è¡¨ç¤º
      function showProgress() {
        const progressBar = document.getElementById("progressBar");
        progressBar.style.display = "block";
        const progressFill = document.getElementById("progressFill");
        progressFill.style.width = "0%";
        setTimeout(() => {
          progressFill.style.width = "100%";
        }, 100);
      }

      // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®éè¡¨ç¤º
      function hideProgress() {
        const progressBar = document.getElementById("progressBar");
        if (progressBar) {
          progressBar.style.display = "none";
          const progressFill = document.getElementById("progressFill");
          progressFill.style.width = "0%";
        }
      }

      // ç”»åƒã‚’JPEGã«å¤‰æ›ã—ã€ãƒªã‚µã‚¤ã‚ºã™ã‚‹é–¢æ•°
      async function convertImage(file, quality, maxWidth) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = function (event) {
            const img = new Image();
            img.onload = function () {
              const canvas = document.createElement("canvas");
              const scale = Math.min(maxWidth / img.width, 1);
              canvas.width = img.width * scale;
              canvas.height = img.height * scale;
              const ctx = canvas.getContext("2d");
              ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

              // åœ§ç¸®ã¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã®ãƒã‚§ãƒƒã‚¯
              function compressImage(currentQuality) {
                canvas.toBlob(
                  function (blob) {
                    console.log(`ç¾åœ¨ã®å“è³ª: ${currentQuality}, ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ${blob.size} bytes`);
                    if (blob.size <= 1 * 1024 * 1024 || currentQuality <= 0.5) {
                      // 1MBä»¥ä¸‹ã¾ãŸã¯æœ€ä½å“è³ªã«é”ã—ãŸå ´åˆ
                      resolve(new File([blob], "converted.jpg", { type: "image/jpeg" }));
                    } else {
                      // å“è³ªã‚’ã•ã‚‰ã«ä¸‹ã’ã¦å†åœ§ç¸®
                      compressImage(currentQuality - 0.1);
                    }
                  },
                  "image/jpeg",
                  currentQuality
                );
              }

              compressImage(quality);
            };
            img.onerror = function () {
              reject(new Error("ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"));
            };
            img.src = event.target.result;
          };
          reader.onerror = function () {
            reject(new Error("ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"));
          };
          reader.readAsDataURL(file);
        });
      }
    </script>
  </body>
</html>

